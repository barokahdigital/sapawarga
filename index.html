<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sapa Warga RT04 (Firestore)</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root { --radius:14px; --bg:#f7f8fc; }
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: var(--bg); }
    header { background: linear-gradient(90deg,#2563eb,#1e40af); color:#fff; padding:.9rem 1rem; display:flex; align-items:center; justify-content:space-between; box-shadow:0 6px 20px rgba(0,0,0,0.08); border-bottom: 4px solid rgba(0,0,0,0.03); }
    header .brand { display:flex; gap:.6rem; align-items:center; }
    header img { width:56px; height:56px; border-radius:50%; object-fit:cover; border:2px solid #fff; }
    .ticker { background:#f59e0b; color:#fff; padding:.5rem .8rem; font-weight:700; overflow:hidden; }
    .card-rounded{border-radius:var(--radius); background:#fff; box-shadow:0 8px 24px rgba(12,35,63,0.06);}
    .hidden{display:none!important;}
    .stat-card{border-radius:10px; padding:.6rem; text-align:center; box-shadow:0 6px 18px rgba(0,0,0,0.04);}
    table thead th{background:#f3f4f6}
    @media(max-width:900px){ .desktop-split{flex-direction:column} }
    #loginPage { min-height:100vh; display:flex; align-items:center; justify-content:center; background: linear-gradient(120deg,#2563eb,#1e40af); padding:1rem; }
    .login-card { background:#fff; width:100%; max-width:520px; padding:1.5rem; border-radius:16px; box-shadow:0 12px 36px rgba(0,0,0,0.18); text-align:center; }
  </style>

  <!-- Firebase SDK init & helpers (module) -->
 <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
  import {
    getFirestore, collection, getDocs, addDoc, doc,
    setDoc, updateDoc, deleteDoc, getDoc, query, where, orderBy
  } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

  // Konfigurasi Firebase (perbaikan storageBucket)
  const firebaseConfig = {
    apiKey: "AIzaSyCYQkttPDo9o-UIJ3yuxvVcbT2xAccOL0U",
    authDomain: "sapawarga-a2191.firebaseapp.com",
    projectId: "sapawarga-a2191",
    storageBucket: "sapawarga-a2191.appspot.com",  // âœ… perbaikan
    messagingSenderId: "36344794419",
    appId: "1:36344794419:web:0a6629488022a47aad8246",
    measurementId: "G-TWZQ0GY1SQ"
  };

  // Inisialisasi Firebase
  const app = initializeApp(firebaseConfig);
  try { getAnalytics(app); } catch(e){ console.warn('analytics init skipped',e); }

  // Firestore
  const db = getFirestore(app);

  // --- Firestore helpers ---
  async function loadCollection(col, opts = {}) {
    let q = collection(db, col);
    if(opts.where) q = query(q, where(opts.where.field, opts.where.op, opts.where.value));
    if(opts.orderBy) q = query(q, orderBy(opts.orderBy.field, opts.orderBy.dir || 'asc'));
    const snap = await getDocs(q);
    return snap.docs.map(d => ({ id: d.id, ...d.data() }));
  }
  async function addData(col, data) { return await addDoc(collection(db, col), data); }
  async function updateData(col, id, data) { return await updateDoc(doc(db, col, id), data); }
  async function deleteData(col, id) { return await deleteDoc(doc(db, col, id)); }
  async function setData(col, id, data) { return await setDoc(doc(db, col, id), data); }
  async function getData(col, id) {
    const d = await getDoc(doc(db, col, id));
    return d.exists() ? { id: d.id, ...d.data() } : null;
  }

  window.db = db;
  window.fs = { loadCollection, addData, updateData, deleteData, setData, getData };
</script>
</head>
<body>

<!-- LOGIN -->
<section id="loginPage" style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:1rem;">
  <div class="card login-card">
    <div class="text-center mb-3">
      <img id="logoLogin" src="" alt="Logo" style="width:96px;height:96px;border-radius:12px;object-fit:cover">
      <h4 class="mt-2">SAPA KELUARGA RT04</h4>
      <p class="text-muted mb-0">Selamat Datang di Situs Sapa Keluarga RT 04</p>
    </div>
    <div class="mb-2"><input id="username" class="form-control" placeholder="Username"></div>
    <div class="mb-2"><input id="password" type="password" class="form-control" placeholder="Password"></div>
    <div class="d-grid gap-2">
      <button class="btn btn-primary" onclick="login()">Login</button>
    </div>
    <small class="d-block text-muted mt-3">Copyright: <b>@2025</b> <b>BarokahDigitalMedia</b></small>
  </div>
</section>

<!-- APP -->
<section id="app" class="hidden">
  <header>
    <div class="brand">
      <img id="logoMain" src="" alt="Logo">
      <div>
        <div style="font-weight:700">SAPA KELUARGA RT04</div>
        <div style="font-size:.85rem;opacity:.9">Dashboard Laporan Keuangan dan Data Warga</div>
      </div>
    </div>
    <div class="d-flex align-items-center gap-2">
      <div id="dateTime" style="font-weight:600;margin-right:12px"></div>
      <button class="btn btn-light btn-sm me-1" onclick="openReadme()">README</button>
      <button class="btn btn-danger btn-sm" onclick="logout()">Sign Out</button>
    </div>
  </header>

  <div class="container py-3">
    <!-- Tabs -->
    <ul class="nav nav-tabs" id="tabs">
      <li class="nav-item"><a class="nav-link active" data-target="dashboard">Dashboard</a></li>
      <li class="nav-item"><a class="nav-link" data-target="data">Data Warga</a></li>
      <li class="nav-item"><a class="nav-link" data-target="keuangan">Keuangan</a></li>
      <li class="nav-item adminOnly"><a class="nav-link" data-target="admin">Admin</a></li>
    </ul>

    <!-- DASHBOARD -->
    <div id="dashboard" class="mt-3">
      <div class="card-rounded p-3 mb-3 demografi">
        <h5>Demografi Warga Kita</h5>
        <div class="d-flex desktop-split gap-3" style="align-items:stretch">
          <div style="flex:1">
            <div class="row g-3">
              <div class="col-md-3">
                <div class="stat-card" style="background:linear-gradient(180deg,#3b82f6,#60a5fa);color:#fff;">
                  <div class="small">Total Warga</div>
                  <div id="s_total" class="h4">0</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat-card" style="background:linear-gradient(180deg,#8b5cf6,#a78bfa);color:#fff;">
                  <div class="small">Laki-laki</div>
                  <div id="s_laki" class="h4">0</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat-card" style="background:linear-gradient(180deg,#f59e0b,#fbbf24);color:#000;">
                  <div class="small">Perempuan</div>
                  <div id="s_perempuan" class="h4">0</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat-card" style="background:linear-gradient(180deg,#10b981,#34d399);color:#fff;">
                  <div class="small">Jenis Pekerjaan</div>
                  <div id="s_pekerjaan" class="h5">0</div>
                </div>
              </div>
            </div>

            <div class="row g-3 mt-3">
              <div class="col-md-4">
                <div class="stat-card"><div class="small text-muted">Anak (&lt;18)</div><div id="s_anak" class="h5">0</div></div>
              </div>
              <div class="col-md-4">
                <div class="stat-card"><div class="small text-muted">Dewasa (18-59)</div><div id="s_dewasa" class="h5">0</div></div>
              </div>
              <div class="col-md-4">
                <div class="stat-card"><div class="small text-muted">Lansia (>=60)</div><div id="s_lansia" class="h5">0</div></div>
              </div>
            </div>
          </div>

          <div style="flex:1">
            <div class="card-rounded p-3 h-100">
              <h6>Grafik Demografi</h6>
              <canvas id="chartDemografi" style="max-height:320px"></canvas>
              <div class="mt-2 small text-muted">Persentase Warga RT 04 Berdasarkan Category.</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card-rounded p-3 keuangan">
        <h5>Laporan Keuangan Kita</h5>
        <div class="d-flex desktop-split gap-3" style="align-items:stretch">
          <div style="flex:1">
            <div class="card-rounded p-3 h-100">
              <h6>Grafik Kas per Kategori</h6>
              <canvas id="chartKeuangan" style="max-height:320px"></canvas>
              <div class="mt-2 small text-muted">Perbandingan kas: Insiba / Ronda / Donasi / Umum.</div>
            </div>
          </div>

          <div style="flex:1">
            <div class="row g-3">
              <div class="col-md-6">
                <div class="stat-card" style="background:linear-gradient(180deg,#16a34a,#34d399);color:#fff;">
                  <div class="small">Total Pemasukan</div>
                  <div id="k_total_in" class="h5">Rp0</div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="stat-card" style="background:linear-gradient(180deg,#ef4444,#fb7185);color:#fff;">
                  <div class="small">Total Pengeluaran</div>
                  <div id="k_total_out" class="h5">Rp0</div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="stat-card" style="background:linear-gradient(180deg,#155e75,#2dd4bf);color:#fff;">
                  <div class="small">Kas Insiba</div>
                  <div id="k_insiba" class="h5">Rp0</div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="stat-card" style="background:linear-gradient(180deg,#7c2d12,#fb923c);color:#fff;">
                  <div class="small">Kas Ronda</div>
                  <div id="k_ronda" class="h5">Rp0</div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="stat-card" style="background:linear-gradient(180deg,#065f46,#34d399);color:#fff;">
                  <div class="small">Donasi</div>
                  <div id="k_donasi" class="h5">Rp0</div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="stat-card" style="background:linear-gradient(180deg,#0ea5e9,#60a5fa);color:#fff;">
                  <div class="small">Kas Umum</div>
                  <div id="k_umum" class="h5">Rp0</div>
                </div>
              </div>

              <div class="col-12">
                <div class="small text-muted">Catatan: Scorecard menunjukkan saldo akhir per kas.</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- DATA WARGA -->
    <div id="data" class="mt-3 hidden">
      <div class="card-rounded p-3">
        <div class="d-flex justify-content-between align-items-center">
          <h5>Data Warga</h5>
          <div class="d-flex gap-2 align-items-center">
            <input id="searchWarga" class="form-control" style="width:240px" placeholder="Cari...">
            <button class="btn btn-outline-primary" onclick="exportCSV('tableWarga')">Export CSV</button>
            <button class="btn btn-outline-danger" onclick="exportTablePrint('tableWarga','Data Warga')">Print</button>
          </div>
        </div>

        <div class="table-responsive mt-3">
          <table id="tableWarga" class="table table-bordered align-middle">
            <thead>
              <tr><th>NIK</th><th>Nama</th><th>TTL (Tgl Lahir)</th><th>Usia</th><th>RT</th><th>RW</th><th>JK</th><th>Jenis Pekerjaan</th><th>Penghasilan</th><th>Aksi</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- KEUANGAN -->
    <div id="keuangan" class="mt-3 hidden">
      <div class="card-rounded p-3">
        <div class="d-flex justify-content-between align-items-center">
          <h5>Data Keuangan</h5>
          <div class="d-flex gap-2 align-items-center">
            <input id="searchKeu" class="form-control" style="width:200px" placeholder="Cari...">
            <select id="filterKategori" class="form-select" style="width:160px"><option value="">Semua Kategori</option><option value="Insiba">Insiba</option><option value="Ronda">Ronda</option><option value="Donasi">Donasi</option><option value="Umum">Umum</option></select>
            <button class="btn btn-outline-primary" onclick="exportCSV('tableKeuangan')">Export CSV</button>
            <button class="btn btn-outline-danger" onclick="exportTablePrint('tableKeuangan','Data Keuangan')">Print</button>
          </div>
        </div>
        <div class="table-responsive mt-3">
          <table id="tableKeuangan" class="table table-bordered">
            <thead><tr><th>Tanggal</th><th>Keterangan</th><th>Kategori</th><th>Pemasukan</th><th>Pengeluaran</th><th>Saldo (Running)</th><th>Aksi</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ADMIN -->
    <div id="admin" class="mt-3 hidden">
      <div class="row g-3">
        <div class="col-md-4">
          <div class="card-rounded p-3">
            <h6>Upload Logo</h6>
            <input type="file" accept="image/*" id="logoUpload" class="form-control" onchange="handleLogoUpload(event)">
            <div class="small text-muted mt-2">Logo akan disimpan ke Firestore (settings/logo).</div>
          </div>
        </div>

        <div class="col-md-8">
          <div class="card-rounded p-3">
            <h6>Tambah / Edit Data Warga</h6>
            <div class="row g-2">
              <div class="col-md-3"><input id="fNIK" class="form-control" placeholder="NIK"></div>
              <div class="col-md-3"><input id="fNama" class="form-control" placeholder="Nama"></div>
              <div class="col-md-3"><input id="fTglLahir" type="date" class="form-control" placeholder="Tgl Lahir"></div>
              <div class="col-md-3"><select id="fJK" class="form-select"><option value="">JK</option><option value="L">L</option><option value="P">P</option></select></div>

              <div class="col-md-3"><input id="fRT" class="form-control" placeholder="RT"></div>
              <div class="col-md-3"><input id="fRW" class="form-control" placeholder="RW"></div>
              <div class="col-md-3"><input id="fJob" class="form-control" placeholder="Pekerjaan"></div>
              <div class="col-md-3"><input id="fPenghasilan" type="number" class="form-control" placeholder="Penghasilan (Rp)"></div>
            </div>
            <div class="d-flex gap-2 mt-3">
              <button id="btnSaveWarga" class="btn btn-success" onclick="saveWargaFromAdmin()">Simpan Warga</button>
              <button class="btn btn-outline-secondary" onclick="resetWargaForm()">Reset</button>
            </div>
          </div>
        </div>

        <div class="col-12">
          <div class="card-rounded p-3">
            <h6>Tambah / Edit Data Keuangan</h6>
            <div class="row g-2">
              <div class="col-md-2"><input id="fTgl" type="date" class="form-control"></div>
              <div class="col-md-5"><input id="fKet" class="form-control" placeholder="Keterangan"></div>
              <div class="col-md-2"><select id="fKategori" class="form-select"><option value="Umum">Umum</option><option value="Insiba">Insiba</option><option value="Ronda">Ronda</option><option value="Donasi">Donasi</option></select></div>
              <div class="col-md-1"><input id="fMasuk" type="number" class="form-control" placeholder="Masuk"></div>
              <div class="col-md-1"><input id="fKeluar" type="number" class="form-control" placeholder="Keluar"></div>
            </div>
            <div class="d-flex gap-2 mt-3">
              <button id="btnSaveKeu" class="btn btn-success" onclick="saveKeuFromAdmin()">Simpan Keuangan</button>
              <button class="btn btn-outline-secondary" onclick="resetKeuForm()">Reset</button>
            </div>

            <div class="card-rounded p-3 mt-3">
              <h6>Saldo Awal Per Kas (Setting)</h6>
              <div class="row g-2 align-items-end">
                <div class="col-md-3"><label class="form-label small">Insiba</label><input id="bInsiba" type="number" class="form-control" placeholder="Saldo awal Insiba (Rp)"></div>
                <div class="col-md-3"><label class="form-label small">Ronda</label><input id="bRonda" type="number" class="form-control" placeholder="Saldo awal Ronda (Rp)"></div>
                <div class="col-md-3"><label class="form-label small">Donasi</label><input id="bDonasi" type="number" class="form-control" placeholder="Saldo awal Donasi (Rp)"></div>
                <div class="col-md-3"><label class="form-label small">Umum</label><input id="bUmum" type="number" class="form-control" placeholder="Saldo awal Umum (Rp)"></div>
                <div class="col-12 mt-2"><button class="btn btn-primary" onclick="saveInitialBalances()">Simpan Saldo Awal</button></div>
              </div>
              <div class="mt-2 small text-muted">Saldo awal akan ditambahkan saat menghitung saldo akhir tiap kas.</div>
            </div>

          </div>
        </div>

      </div>
    </div>

  </div><!-- container -->
</section>

<!-- README modal -->
<div class="modal fade" id="modalReadme" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content">
  <div class="modal-header"><h5 class="modal-title">README</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
  <div class="modal-body">
    <ul>
      <li>Login admin/admin123 untuk akses penuh, user/user123 untuk read-only.</li>
      <li>Unggah logo di tab Admin (disimpan di Firestore pada dokumen settings/logo).</li>
      <li>Dashboard terbagi: Demografi & Laporan Keuangan.</li>
      <li>Pada tab Admin Anda dapat mengatur saldo awal per kas, lalu tambah transaksi dengan kategori.</li>
    </ul>
  </div>
  <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button></div>
</div></div></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const el = s => document.querySelector(s);
  const els = s => Array.from(document.querySelectorAll(s));
  const IDR = n => new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',maximumFractionDigits:0}).format(n||0);

  // State
  let warga = [], keuangan = [], accounts = { Insiba:0, Ronda:0, Donasi:0, Umum:0 };
  let currentRole = null;
  let chartDem = null, chartKeu = null;

  // --- Clock
  function startClock(){ updateClock(); if(window._clockInterval) clearInterval(window._clockInterval); window._clockInterval = setInterval(updateClock,1000); }
  function updateClock(){ const now=new Date(); const hari=['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'][now.getDay()]; const fmt = now.toLocaleString('id-ID',{ day:'2-digit', month:'long', year:'numeric', hour:'2-digit', minute:'2-digit'}); el('#dateTime').textContent = `${hari}, ${fmt}`; }

  // --- Utility
  function uid(prefix='id'){ return prefix + '_' + Date.now().toString(36).slice(4) + Math.random().toString(36).slice(2,6); }
  function calcAge(birthStr){ if(!birthStr) return null; const b = new Date(birthStr); const now = new Date(); let age = now.getFullYear() - b.getFullYear(); const m = now.getMonth() - b.getMonth(); if(m < 0 || (m === 0 && now.getDate() < b.getDate())) age--; return age; }
  function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

  // --- Load initial settings (logo + accounts)
  async function loadSettings(){
    // logo
    try {
      const logoDoc = await fs.getData('settings','logo');
      if(logoDoc && logoDoc.dataUrl){
        el('#logoMain').src = logoDoc.dataUrl;
        el('#logoLogin').src = logoDoc.dataUrl;
      } else {
        // fallback image placeholder
        el('#logoMain').src = '';
        el('#logoLogin').src = '';
      }
    } catch(e){ console.warn('logo load err',e); }

    // accounts
    try {
      const acc = await fs.getData('settings','accounts');
      if(acc){
        accounts = { Insiba:+acc.Insiba||0, Ronda:+acc.Ronda||0, Donasi:+acc.Donasi||0, Umum:+acc.Umum||0 };
      }
    } catch(e){ console.warn('accounts load err',e); }
  }

  // --- Render Warga
  function renderWargaTable(){
    const tbody = el('#tableWarga tbody'); tbody.innerHTML='';
    warga.forEach((w) => {
      const age = calcAge(w.tgl_lahir);
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${escapeHtml(w.nik||'')}</td>
        <td>${escapeHtml(w.nama||'')}</td>
        <td>${w.tgl_lahir||''}</td>
        <td>${age===null?'':age+' th'}</td>
        <td>${w.rt||''}</td><td>${w.rw||''}</td><td>${w.jk||''}</td>
        <td>${escapeHtml(w.job||'')}</td><td>${IDR(w.penghasilan||0)}</td>
        <td>${
          currentRole==='admin' ? `<button class="btn btn-sm btn-outline-primary me-1" onclick="editWarga('${w.id}')">Edit</button>
          <button class="btn btn-sm btn-outline-danger" onclick="deleteWarga('${w.id}')">Hapus</button>` : '-'
        }</td>`;
      tbody.appendChild(tr);
    });
    bindSearch('#searchWarga','#tableWarga');
  }

  function computeDemografi(){
    const total = warga.length;
    const laki = warga.filter(w => (w.jk||'').toUpperCase()==='L').length;
    const perempuan = warga.filter(w => (w.jk||'').toUpperCase()==='P').length;
    const jobSet = new Set(warga.map(w => (w.job||'').trim()).filter(Boolean));
    const pekerjaanCount = jobSet.size;
    let anak=0, dewasa=0, lansia=0;
    warga.forEach(w => { const a = calcAge(w.tgl_lahir); if(a===null) return; if(a < 18) anak++; else if(a >= 60) lansia++; else dewasa++; });
    return { total, laki, perempuan, pekerjaanCount, anak, dewasa, lansia };
  }

  function updateDemografiUI(){
    const d = computeDemografi();
    el('#s_total').textContent = d.total;
    el('#s_laki').textContent = d.laki;
    el('#s_perempuan').textContent = d.perempuan;
    el('#s_pekerjaan').textContent = d.pekerjaanCount;
    el('#s_anak').textContent = d.anak;
    el('#s_dewasa').textContent = d.dewasa;
    el('#s_lansia').textContent = d.lansia;

    const ctx = el('#chartDemografi');
    if(ctx && typeof Chart !== 'undefined'){
      if(chartDem) chartDem.destroy();
      chartDem = new Chart(ctx, {
        type:'doughnut',
        data:{ labels:['Laki-laki','Perempuan','Anak','Dewasa','Lansia'], datasets:[{ data:[d.laki, d.perempuan, d.anak, d.dewasa, d.lansia], backgroundColor:['#3b82f6','#8b5cf6','#f59e0b','#10b981','#60a5fa'] }] },
        options:{ responsive:true, plugins:{legend:{position:'bottom'}}}
      });
    }
  }

  // --- Render Keuangan
  function renderKeuanganTable(){
    const tbody = el('#tableKeuangan tbody'); tbody.innerHTML='';
    const filter = (el('#filterKategori') && el('#filterKategori').value) || '';
    // compute running starting from sum of initial balances (overall starting balance)
    let running = 0;
    // we'll compute per-row running as cumulative of sorted transactions + initial sums
    const init = { ...accounts };
    running = Object.values(init).reduce((a,b)=>a+(+b||0),0);
    // sort by date
    const arr = keuangan.slice().sort((a,b)=> (a.tgl||'').localeCompare(b.tgl||''));
    arr.forEach((k)=>{
      if(filter && k.kategori !== filter) return;
      running += (+k.masuk||0) - (+k.keluar||0);
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${k.tgl||''}</td><td>${escapeHtml(k.ket||'')}</td><td>${escapeHtml(k.kategori||'Umum')}</td><td>${IDR(k.masuk||0)}</td><td>${IDR(k.keluar||0)}</td><td>${IDR(running)}</td>
        <td>${currentRole==='admin' ? `<button class="btn btn-sm btn-outline-primary me-1" onclick="editKeu('${k.id}')">Edit</button><button class="btn btn-sm btn-outline-danger" onclick="deleteKeu('${k.id}')">Hapus</button>` : '-'}</td>`;
      tbody.appendChild(tr);
    });
    bindSearch('#searchKeu','#tableKeuangan');
  }

  function computeAccountBalances(){
    const totals = { Insiba:+accounts.Insiba||0, Ronda:+accounts.Ronda||0, Donasi:+accounts.Donasi||0, Umum:+accounts.Umum||0 };
    ['Insiba','Ronda','Donasi','Umum'].forEach(k=>{ if(!(k in totals)) totals[k]=0; });
    keuangan.forEach(k => {
      const cat = k.kategori || 'Umum';
      const delta = (+k.masuk||0) - (+k.keluar||0);
      if(!(cat in totals)) totals[cat] = 0;
      totals[cat] += delta;
    });
    const masuk = keuangan.reduce((s,k)=> s + (+k.masuk||0), 0);
    const keluar = keuangan.reduce((s,k)=> s + (+k.keluar||0), 0);
    const overall = Object.values(totals).reduce((a,b)=>a+(+b||0),0);
    return { totals, masuk, keluar, overall };
  }

  function updateKeuanganUI(){
    const s = computeAccountBalances();
    el('#k_total_in').textContent = IDR(s.masuk);
    el('#k_total_out').textContent = IDR(s.keluar);
    el('#k_insiba').textContent = IDR(s.totals.Insiba || 0);
    el('#k_ronda').textContent = IDR(s.totals.Ronda || 0);
    el('#k_donasi').textContent = IDR(s.totals.Donasi || 0);
    el('#k_umum').textContent = IDR(s.totals.Umum || s.totals.Umum || s.totals.Umum === 0 ? s.totals.Umum : 0);

    const ctx = el('#chartKeuangan');
    if(ctx && typeof Chart !== 'undefined'){
      if(chartKeu) chartKeu.destroy();
      const labels = ['Insiba','Ronda','Donasi','Umum'];
      const data = labels.map(l => s.totals[l] || 0);
      chartKeu = new Chart(ctx, {
        type:'bar',
        data:{ labels, datasets:[{ label:'Saldo per Kas', data, backgroundColor: labels.map((_,i)=>['#16a34a','#ef4444','#0ea5e9','#f97316'][i%4]) }]},
        options:{ responsive:true, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true } } }
      });
    }
  }

  // --- CRUD Warga
  async function saveWargaFromAdmin(){
    if(currentRole!=='admin') return alert('Hanya admin.');
    const w = {
      nik: el('#fNIK').value.trim(),
      nama: el('#fNama').value.trim(),
      tgl_lahir: el('#fTglLahir').value || '',
      rt: el('#fRT').value.trim(),
      rw: el('#fRW').value.trim(),
      jk: el('#fJK').value || '',
      job: el('#fJob').value.trim(),
      penghasilan: +el('#fPenghasilan').value || 0
    };
    if(!w.nama){ return alert('Nama wajib diisi'); }

    try {
      await fs.addData('warga', w);
      await refreshWarga();
      resetWargaForm();
      alert('Warga disimpan.');
    } catch(e){ console.error(e); alert('Error menyimpan warga'); }
  }
  window.saveWargaFromAdmin = saveWargaFromAdmin;

  function resetWargaForm(){ ['#fNIK','#fNama','#fTglLahir','#fRT','#fRW','#fJK','#fJob','#fPenghasilan'].forEach(id=>{ if(el(id)) el(id).value=''; }); }

  async function editWarga(id){
    const doc = warga.find(x=>x.id===id);
    if(!doc) return alert('Tidak ditemukan');
    el('#fNIK').value = doc.nik || '';
    el('#fNama').value = doc.nama || '';
    el('#fTglLahir').value = doc.tgl_lahir || '';
    el('#fRT').value = doc.rt || '';
    el('#fRW').value = doc.rw || '';
    el('#fJK').value = doc.jk || '';
    el('#fJob').value = doc.job || '';
    el('#fPenghasilan').value = doc.penghasilan || 0;
    const btn = el('#btnSaveWarga');
    btn.textContent = 'Update Warga';
    btn.onclick = async () => {
      try {
        const updated = {
          nik: el('#fNIK').value.trim(),
          nama: el('#fNama').value.trim(),
          tgl_lahir: el('#fTglLahir').value || '',
          rt: el('#fRT').value.trim(),
          rw: el('#fRW').value.trim(),
          jk: el('#fJK').value || '',
          job: el('#fJob').value.trim(),
          penghasilan: +el('#fPenghasilan').value || 0
        };
        await fs.updateData('warga', id, updated);
        await refreshWarga();
        btn.textContent = 'Simpan Warga';
        btn.onclick = saveWargaFromAdmin;
        resetWargaForm();
        // switch to data tab
        document.querySelector('#tabs .nav-link[data-target="data"]').click();
      } catch(e){ console.error(e); alert('Error update warga'); }
    };
    document.querySelector('#tabs .nav-link[data-target="admin"]').click();
  }
  window.editWarga = editWarga;

  async function deleteWarga(id){
    if(currentRole!=='admin') return alert('Hanya admin.');
    if(!confirm('Hapus data warga?')) return;
    try {
      await fs.deleteData('warga', id);
      await refreshWarga();
      alert('Dihapus.');
    } catch(e){ console.error(e); alert('Error hapus'); }
  }
  window.deleteWarga = deleteWarga;

  async function refreshWarga(){ warga = await fs.loadCollection('warga'); renderWargaTable(); updateDemografiUI(); }

  // --- CRUD Keuangan
  async function saveKeuFromAdmin(){
    if(currentRole!=='admin') return alert('Hanya admin.');
    const k = {
      tgl: el('#fTgl').value || new Date().toISOString().slice(0,10),
      ket: el('#fKet').value.trim() || '-',
      kategori: el('#fKategori').value || 'Umum',
      masuk: +el('#fMasuk').value || 0,
      keluar: +el('#fKeluar').value || 0
    };
    if(k.masuk===0 && k.keluar===0) return alert('Isi pemasukan atau pengeluaran.');
    try {
      await fs.addData('keuangan', k);
      await refreshKeuangan();
      resetKeuForm();
      alert('Catatan keuangan disimpan.');
    } catch(e){ console.error(e); alert('Error menyimpan keuangan'); }
  }
  window.saveKeuFromAdmin = saveKeuFromAdmin;
  function resetKeuForm(){ ['#fTgl','#fKet','#fKategori','#fMasuk','#fKeluar'].forEach(id=>{ if(el(id)) el(id).value=''; }); }

  async function editKeu(id){
    const doc = keuangan.find(x=>x.id===id); if(!doc) return alert('Tidak ditemukan');
    el('#fTgl').value = doc.tgl || '';
    el('#fKet').value = doc.ket || '';
    el('#fKategori').value = doc.kategori || 'Umum';
    el('#fMasuk').value = doc.masuk || 0;
    el('#fKeluar').value = doc.keluar || 0;
    const btn = el('#btnSaveKeu');
    btn.textContent = 'Update Keuangan';
    btn.onclick = async () => {
      try {
        const updated = {
          tgl: el('#fTgl').value || new Date().toISOString().slice(0,10),
          ket: el('#fKet').value.trim() || '-',
          kategori: el('#fKategori').value || 'Umum',
          masuk: +el('#fMasuk').value || 0,
          keluar: +el('#fKeluar').value || 0
        };
        await fs.updateData('keuangan', id, updated);
        await refreshKeuangan();
        btn.textContent = 'Simpan Keuangan';
        btn.onclick = saveKeuFromAdmin;
        resetKeuForm();
        document.querySelector('#tabs .nav-link[data-target="keuangan"]').click();
      } catch(e){ console.error(e); alert('Error update keuangan'); }
    };
    document.querySelector('#tabs .nav-link[data-target="admin"]').click();
  }
  window.editKeu = editKeu;

  async function deleteKeu(id){
    if(currentRole!=='admin') return alert('Hanya admin.');
    if(!confirm('Hapus catatan keuangan?')) return;
    try {
      await fs.deleteData('keuangan', id);
      await refreshKeuangan();
      alert('Dihapus.');
    } catch(e){ console.error(e); alert('Error hapus keuangan'); }
  }
  window.deleteKeu = deleteKeu;

  async function refreshKeuangan(){ keuangan = await fs.loadCollection('keuangan'); renderKeuanganTable(); updateKeuanganUI(); }

  // --- Initial balances (accounts)
  function loadInitialBalancesToForm(){
    el('#bInsiba').value = accounts.Insiba || 0;
    el('#bRonda').value = accounts.Ronda || 0;
    el('#bDonasi').value = accounts.Donasi || 0;
    el('#bUmum').value = accounts.Umum || accounts.Umum || accounts.Umum === 0 ? accounts.Umum : 0;
  }
  async function saveInitialBalances(){
    const acc = { Insiba:+el('#bInsiba').value||0, Ronda:+el('#bRonda').value||0, Donasi:+el('#bDonasi').value||0, Umum:+el('#bUmum').value||0 };
    try {
      await fs.setData('settings','accounts', acc);
      accounts = acc;
      alert('Saldo awal disimpan.');
      await refreshKeuangan(); // recompute UI
    } catch(e){ console.error(e); alert('Error menyimpan saldo awal'); }
  }
  window.saveInitialBalances = saveInitialBalances;

  // --- Logo upload (saved to settings/logo as dataUrl)
  window.handleLogoUpload = function(e){
    const f = e.target.files[0]; if(!f) return alert('Pilih gambar.');
    const r = new FileReader();
    r.onload = async ev => {
      const data = ev.target.result;
      try {
        await fs.setData('settings','logo',{ dataUrl: data, updatedAt: new Date().toISOString() });
        el('#logoMain').src = data; el('#logoLogin').src = data;
        alert('Logo tersimpan (Firestore).');
      } catch(err){ console.error(err); alert('Error simpan logo'); }
    };
    r.readAsDataURL(f);
  }

  // --- Export / Print
  function exportCSV(tableId){
    const table = document.getElementById(tableId);
    if(!table) return;
    const rows = Array.from(table.querySelectorAll('tr'));
    const csv = rows.map(row => {
      const cols = Array.from(row.querySelectorAll('th,td'));
      return cols.map(c => `"${(c.innerText||'').replace(/"/g,'""')}"`).join(',');
    }).join('\n');
    const blob = new Blob([csv], { type:'text/csv' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = tableId + '.csv'; a.click(); URL.revokeObjectURL(a.href);
  }
  window.exportCSV = exportCSV;

  function exportTablePrint(tableId, title){
    const table = document.getElementById(tableId);
    const w = window.open('', '_blank');
    w.document.write('<html><head><title>'+title+'</title><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"></head><body>');
    w.document.write('<h3>'+title+'</h3>');
    w.document.write(table.outerHTML);
    w.document.write('</body></html>');
    w.document.close();
    w.print();
  }
  window.exportTablePrint = exportTablePrint;

  // --- Search binding
  function bindSearch(inpSel, tableSel){
    const inp = document.querySelector(inpSel); if(!inp) return;
    inp.addEventListener('input', ()=> {
      const q = inp.value.toLowerCase();
      Array.from(document.querySelectorAll(tableSel + ' tbody tr')).forEach(tr => {
        tr.style.display = tr.innerText.toLowerCase().includes(q) ? '' : 'none';
      });
    });
  }

  // --- Tabs binding
  els('#tabs .nav-link').forEach(a=>{
    a.addEventListener('click', ()=>{
      els('#tabs .nav-link').forEach(x=>x.classList.remove('active'));
      a.classList.add('active');
      const tgt = a.dataset.target;
      ['dashboard','data','keuangan','admin'].forEach(id=>{
        const node = document.getElementById(id); if(!node) return;
        if(id===tgt) node.classList.remove('hidden'); else node.classList.add('hidden');
      });
    });
  });

  // --- Render all
  async function renderAll(){
    startClock();
    await loadSettings();
    await refreshWarga();
    await refreshKeuangan();
    loadInitialBalancesToForm();
    updateDemografiUI();
    updateKeuanganUI();
  }

  // --- Login/logout
  window.fillDemo = function(){ el('#username').value='admin'; el('#password').value='admin123'; }
  window.login = async function(){
    const u = el('#username').value.trim(), p = el('#password').value.trim();
    if(u==='admin' && p==='admin123') currentRole='admin';
    else if(u==='user' && p==='user123') currentRole='user';
    else { alert('Creds salah! (admin/admin123, user/user123)'); return; }
    el('#loginPage').classList.add('hidden');
    el('#app').classList.remove('hidden');
    if(currentRole!=='admin') els('.adminOnly').forEach(x=>x.classList.add('hidden'));
    await renderAll();
  }
  window.logout = function(){ location.reload(); }
  window.openReadme = function(){ new bootstrap.Modal(document.getElementById('modalReadme')).show(); }

  // --- helpers to refresh lists quickly (used above)
  async function refreshWargaAndUI(){ await refreshWarga(); updateDemografiUI(); }
  async function refreshKeuanganAndUI(){ await refreshKeuangan(); updateKeuanganUI(); }

  // --- initial call setup for filter change
  if(el('#filterKategori')) el('#filterKategori').addEventListener('change', ()=> renderKeuanganTable());

  // Expose debug
  window._debug = { getWarga:()=>warga, getKeuangan:()=>keuangan, getAccounts:()=>accounts };

  // Initial: show login only. (Everything loads after login)
});
</script>
</body>
</html>
